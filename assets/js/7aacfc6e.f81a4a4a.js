"use strict";(self.webpackChunkfiber_docs=self.webpackChunkfiber_docs||[]).push([["45870"],{81198:function(e,t,n){n.r(t),n.d(t,{frontMatter:()=>s,toc:()=>d,default:()=>h,metadata:()=>r,assets:()=>c,contentTitle:()=>a});var r=JSON.parse('{"id":"middleware/keyauth","title":"KeyAuth","description":"The KeyAuth middleware implements API key authentication.","source":"@site/versioned_docs/version-v3.x/middleware/keyauth.md","sourceDirName":"middleware","slug":"/middleware/keyauth","permalink":"/middleware/keyauth","draft":false,"unlisted":false,"tags":[],"version":"v3.x","lastUpdatedAt":1771794478000,"frontMatter":{"id":"keyauth"},"sidebar":"left_sidebar","previous":{"title":"Idempotency","permalink":"/middleware/idempotency"},"next":{"title":"Limiter","permalink":"/middleware/limiter"}}'),i=n(74848),l=n(84429);let s={id:"keyauth"},a="KeyAuth",c={},d=[{value:"Signatures",id:"signatures",level:2},{value:"Examples",id:"examples",level:2},{value:"Basic example",id:"basic-example",level:3},{value:"Authenticate only certain endpoints",id:"authenticate-only-certain-endpoints",level:3},{value:"Apply middleware in the handler",id:"apply-middleware-in-the-handler",level:3},{value:"Key Extractors",id:"key-extractors",level:2},{value:"Typical Usage",id:"typical-usage",level:3},{value:"Config",id:"config",level:2},{value:"Default Config",id:"default-config",level:2}];function o(e){let t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"keyauth",children:"KeyAuth"})}),"\n",(0,i.jsx)(t.p,{children:"The KeyAuth middleware implements API key authentication."}),"\n",(0,i.jsx)(t.h2,{id:"signatures",children:"Signatures"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:"func New(config ...Config) fiber.Handler\nfunc TokenFromContext(c fiber.Ctx) string\n"})}),"\n",(0,i.jsx)(t.h2,{id:"examples",children:"Examples"}),"\n",(0,i.jsx)(t.h3,{id:"basic-example",children:"Basic example"}),"\n",(0,i.jsx)(t.p,{children:"This example registers KeyAuth with an API key stored in a cookie."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'package main\n\nimport (\n    "crypto/sha256"\n    "crypto/subtle"\n    "github.com/gofiber/fiber/v3"\n    "github.com/gofiber/fiber/v3/middleware/keyauth"\n)\n\nvar (\n    apiKey = "correct horse battery staple"\n)\n\nfunc validateAPIKey(c fiber.Ctx, key string) (bool, error) {\n    hashedAPIKey := sha256.Sum256([]byte(apiKey))\n    hashedKey := sha256.Sum256([]byte(key))\n\n    if subtle.ConstantTimeCompare(hashedAPIKey[:], hashedKey[:]) == 1 {\n        return true, nil\n    }\n    return false, keyauth.ErrMissingOrMalformedAPIKey\n}\n\nfunc main() {\n    app := fiber.New()\n\n    // Register middleware before the routes that need it\n    app.Use(keyauth.New(keyauth.Config{\n        Extractor:  keyauth.FromCookie("access_token"),\n        Validator:  validateAPIKey,\n    }))\n\n    app.Get("/", func(c fiber.Ctx) error {\n        return c.SendString("Successfully authenticated!")\n    })\n\n    app.Listen(":3000")\n}\n'})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"Test:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:'# No API key specified -> 401 Missing or invalid API Key\ncurl http://localhost:3000\n#> Missing or invalid API Key\n\n# Correct API key -> 200 OK\ncurl --cookie "access_token=correct horse battery staple" http://localhost:3000\n#> Successfully authenticated!\n\n# Incorrect API key -> 401 Missing or invalid API Key\ncurl --cookie "access_token=Clearly A Wrong Key" http://localhost:3000\n#> Missing or invalid API Key\n'})}),"\n",(0,i.jsxs)(t.p,{children:["For a more detailed example, see the ",(0,i.jsx)(t.a,{href:"https://github.com/gofiber/recipes/tree/master/fiber-envoy-extauthz",children:(0,i.jsx)(t.code,{children:"fiber-envoy-extauthz"})})," recipe in the ",(0,i.jsx)(t.code,{children:"gofiber/recipes"})," repository."]}),"\n",(0,i.jsx)(t.h3,{id:"authenticate-only-certain-endpoints",children:"Authenticate only certain endpoints"}),"\n",(0,i.jsxs)(t.p,{children:["Use the ",(0,i.jsx)(t.code,{children:"Next"})," function to run KeyAuth only on selected routes."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'package main\n\nimport (\n    "crypto/sha256"\n    "crypto/subtle"\n    "github.com/gofiber/fiber/v3"\n    "github.com/gofiber/fiber/v3/middleware/keyauth"\n    "regexp"\n    "strings"\n)\n\nvar (\n    apiKey        = "correct horse battery staple"\n    protectedURLs = []*regexp.Regexp{\n        regexp.MustCompile("^/authenticated$"),\n        regexp.MustCompile("^/auth2$"),\n    }\n)\n\nfunc validateAPIKey(c fiber.Ctx, key string) (bool, error) {\n    hashedAPIKey := sha256.Sum256([]byte(apiKey))\n    hashedKey := sha256.Sum256([]byte(key))\n\n    if subtle.ConstantTimeCompare(hashedAPIKey[:], hashedKey[:]) == 1 {\n        return true, nil\n    }\n    return false, keyauth.ErrMissingOrMalformedAPIKey\n}\n\nfunc authFilter(c fiber.Ctx) bool {\n    originalURL := strings.ToLower(c.OriginalURL())\n\n    for _, pattern := range protectedURLs {\n        if pattern.MatchString(originalURL) {\n            // Run middleware for protected routes\n            return false\n        }\n    }\n    // Skip middleware for non-protected routes\n    return true\n}\n\nfunc main() {\n    app := fiber.New()\n\n    app.Use(keyauth.New(keyauth.Config{\n        Next:      authFilter,\n        Extractor: keyauth.FromCookie("access_token"),\n        Validator: validateAPIKey,\n    }))\n\n    app.Get("/", func(c fiber.Ctx) error {\n        return c.SendString("Welcome")\n    })\n    app.Get("/authenticated", func(c fiber.Ctx) error {\n        return c.SendString("Successfully authenticated!")\n    })\n    app.Get("/auth2", func(c fiber.Ctx) error {\n        return c.SendString("Successfully authenticated 2!")\n    })\n\n    app.Listen(":3000")\n}\n'})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"Test:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:'# / doesn\'t require authentication\ncurl http://localhost:3000\n#> Welcome\n\n# /authenticated requires authentication\ncurl --cookie "access_token=correct horse battery staple" http://localhost:3000/authenticated\n#> Successfully authenticated!\n\n# /auth2 requires authentication too\ncurl --cookie "access_token=correct horse battery staple" http://localhost:3000/auth2\n#> Successfully authenticated 2!\n'})}),"\n",(0,i.jsx)(t.h3,{id:"apply-middleware-in-the-handler",children:"Apply middleware in the handler"}),"\n",(0,i.jsxs)(t.p,{children:["You can apply the middleware to specific routes or groups instead of globally. This example uses the default extractor (",(0,i.jsx)(t.code,{children:"FromAuthHeader"}),")."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'package main\n\nimport (\n    "crypto/sha256"\n    "crypto/subtle"\n    "github.com/gofiber/fiber/v3"\n    "github.com/gofiber/fiber/v3/middleware/keyauth"\n)\n\nconst (\n  apiKey = "my-super-secret-key"\n)\n\nfunc main() {\n    app := fiber.New()\n\n    authMiddleware := keyauth.New(keyauth.Config{\n        Validator:  func(c fiber.Ctx, key string) (bool, error) {\n            hashedAPIKey := sha256.Sum256([]byte(apiKey))\n            hashedKey := sha256.Sum256([]byte(key))\n\n            if subtle.ConstantTimeCompare(hashedAPIKey[:], hashedKey[:]) == 1 {\n                return true, nil\n            }\n            return false, keyauth.ErrMissingOrMalformedAPIKey\n        },\n    })\n\n    app.Get("/", func(c fiber.Ctx) error {\n        return c.SendString("Welcome")\n    })\n\n    app.Get("/allowed",  authMiddleware, func(c fiber.Ctx) error {\n        return c.SendString("Successfully authenticated!")\n    })\n\n    app.Listen(":3000")\n}\n'})}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.strong,{children:"Test:"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:'# / doesn\'t require authentication\ncurl http://localhost:3000\n#> Welcome\n\n# /allowed requires authentication\ncurl --header "Authorization: Bearer my-super-secret-key"  http://localhost:3000/allowed\n#> Successfully authenticated!\n'})}),"\n",(0,i.jsx)(t.h2,{id:"key-extractors",children:"Key Extractors"}),"\n",(0,i.jsxs)(t.p,{children:["KeyAuth uses an ",(0,i.jsx)(t.code,{children:"Extractor"})," from the shared ",(0,i.jsx)(t.a,{href:"../guide/extractors",children:"extractors"})," package to retrieve the API key from the request. You can specify one or more extractors in the configuration. For a full list of extractors, chaining, and advanced usage, see the ",(0,i.jsx)(t.a,{href:"../guide/extractors",children:"Extractors Guide"}),"."]}),"\n",(0,i.jsx)(t.h3,{id:"typical-usage",children:"Typical Usage"}),"\n",(0,i.jsx)(t.p,{children:"Specify the extractor in the config. For example, to extract from a cookie:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'app.Use(keyauth.New(keyauth.Config{\n    Extractor: extractors.FromCookie("access_token"),\n    Validator: validateAPIKey,\n}))\n'})}),"\n",(0,i.jsx)(t.p,{children:"To use the default (Authorization header with Bearer scheme):"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'app.Use(keyauth.New(keyauth.Config{\n    Validator: validateAPIKey, // Extractor defaults to FromAuthHeader("Bearer")\n}))\n'})}),"\n",(0,i.jsx)(t.p,{children:"To try multiple sources (header, then query):"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'app.Use(keyauth.New(keyauth.Config{\n    Extractor: extractors.Chain(\n        extractors.FromHeader("X-API-Key"),\n        extractors.FromQuery("api_key"),\n    ),\n    Validator: validateAPIKey,\n}))\n'})}),"\n",(0,i.jsxs)(t.p,{children:["For custom logic, use ",(0,i.jsx)(t.code,{children:"extractors.FromCustom"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'app.Use(keyauth.New(keyauth.Config{\n    Extractor: extractors.FromCustom(func(c fiber.Ctx) (string, error) {\n        return c.Get("X-My-API-Key"), nil\n    }),\n    Validator: validateAPIKey,\n}))\n'})}),"\n",(0,i.jsxs)(t.p,{children:["Refer to the ",(0,i.jsx)(t.a,{href:"../guide/extractors",children:"Extractors Guide"})," for details, security notes, and advanced configuration."]}),"\n",(0,i.jsx)(t.h2,{id:"config",children:"Config"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Property"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Type"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Description"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Default"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Next"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"func(fiber.Ctx) bool"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Next defines a function to skip this middleware when it returns true."}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"nil"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"SuccessHandler"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"fiber.Handler"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"SuccessHandler defines a function which is executed for a valid key."}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"c.Next()"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"ErrorHandler"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"fiber.ErrorHandler"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["ErrorHandler defines a function which is executed for an invalid key. By default a 401 response with a ",(0,i.jsx)(t.code,{children:"WWW-Authenticate"})," challenge is sent."]}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Default error handler"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Validator"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"func(fiber.Ctx, string) (bool, error)"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,i.jsx)(t.strong,{children:"Required."})," Validator is a function to validate the key."]}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,i.jsx)(t.code,{children:"nil"})," (panic)"]})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Extractor"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"extractors.Extractor"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["Extractor defines how to retrieve the key from the request. Use helper functions from the shared extractors package, e.g. ",(0,i.jsx)(t.code,{children:'extractors.FromAuthHeader("Bearer")'})," or ",(0,i.jsx)(t.code,{children:'extractors.FromCookie("access_token")'}),"."]}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:'extractors.FromAuthHeader("Bearer")'})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Realm"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["Realm specifies the protected area name used in the ",(0,i.jsx)(t.code,{children:"WWW-Authenticate"})," header."]}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:'"Restricted"'})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Challenge"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["Value of the ",(0,i.jsx)(t.code,{children:"WWW-Authenticate"})," header when no ",(0,i.jsx)(t.code,{children:"Authorization"})," scheme is present."]}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:'ApiKey realm="Restricted"'})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Error"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["Error code appended as the ",(0,i.jsx)(t.code,{children:"error"})," parameter in Bearer challenges. Must be ",(0,i.jsx)(t.code,{children:"invalid_request"}),", ",(0,i.jsx)(t.code,{children:"invalid_token"}),", or ",(0,i.jsx)(t.code,{children:"insufficient_scope"}),"."]}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:'""'})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"ErrorDescription"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["Human-readable text for the ",(0,i.jsx)(t.code,{children:"error_description"})," parameter in Bearer challenges. Requires ",(0,i.jsx)(t.code,{children:"Error"}),"."]}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:'""'})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"ErrorURI"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["URI identifying a human-readable web page with information about the ",(0,i.jsx)(t.code,{children:"error"})," in Bearer challenges. Requires ",(0,i.jsx)(t.code,{children:"Error"})," and must be an absolute URI."]}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:'""'})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Scope"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"string"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["Space-delimited list of scopes for the ",(0,i.jsx)(t.code,{children:"scope"})," parameter in Bearer challenges. Each token must conform to the RFC 6750 ",(0,i.jsx)(t.code,{children:"scope-token"})," syntax and requires ",(0,i.jsx)(t.code,{children:"Error"})," set to ",(0,i.jsx)(t.code,{children:"insufficient_scope"}),"."]}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:'""'})})]})]})]}),"\n",(0,i.jsx)(t.h2,{id:"default-config",children:"Default Config"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'var ConfigDefault = Config{\n    SuccessHandler: func(c fiber.Ctx) error {\n        return c.Next()\n    },\n    ErrorHandler: func(c fiber.Ctx, _ error) error {\n        return c.Status(fiber.StatusUnauthorized).SendString(ErrMissingOrMalformedAPIKey.Error())\n    },\n    Realm:     "Restricted",\n    Extractor: extractors.FromAuthHeader("Bearer"),\n}\n'})})]})}function h(e={}){let{wrapper:t}={...(0,l.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},84429:function(e,t,n){n.d(t,{R:()=>s,x:()=>a});var r=n(96540);let i={},l=r.createContext(i);function s(e){let t=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),r.createElement(l.Provider,{value:t},e.children)}}}]);