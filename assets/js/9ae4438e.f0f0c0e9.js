"use strict";(self.webpackChunkfiber_docs=self.webpackChunkfiber_docs||[]).push([["31729"],{54107:function(e,t,n){n.r(t),n.d(t,{frontMatter:()=>o,toc:()=>a,default:()=>h,metadata:()=>r,assets:()=>d,contentTitle:()=>s});var r=JSON.parse('{"id":"middleware/timeout","title":"Timeout","description":"The timeout middleware enforces a deadline on handler execution. It wraps handlers with","source":"@site/versioned_docs/version-v3.x/middleware/timeout.md","sourceDirName":"middleware","slug":"/middleware/timeout","permalink":"/middleware/timeout","draft":false,"unlisted":false,"tags":[],"version":"v3.x","lastUpdatedAt":1771794478000,"frontMatter":{"id":"timeout"},"sidebar":"left_sidebar","previous":{"title":"Static","permalink":"/middleware/static"},"next":{"title":"\u{1F50C} Addon","permalink":"/category/-addon"}}'),i=n(74848),l=n(84429);let o={id:"timeout"},s="Timeout",d={},a=[{value:"How It Works",id:"how-it-works",level:2},{value:"Known limitations",id:"known-limitations",level:2},{value:"Signatures",id:"signatures",level:2},{value:"Examples",id:"examples",level:2},{value:"Basic example",id:"basic-example",level:3},{value:"Config",id:"config",level:2},{value:"Use with a custom error",id:"use-with-a-custom-error",level:3},{value:"Sample usage with a database call",id:"sample-usage-with-a-database-call",level:3}];function c(e){let t={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"timeout",children:"Timeout"})}),"\n",(0,i.jsxs)(t.p,{children:["The timeout middleware enforces a deadline on handler execution. It wraps handlers with\n",(0,i.jsx)(t.code,{children:"context.WithTimeout"}),", exposes the derived context through ",(0,i.jsx)(t.code,{children:"c.Context()"}),", and\nreturns ",(0,i.jsx)(t.code,{children:"408 Request Timeout"})," when the deadline is exceeded."]}),"\n",(0,i.jsx)(t.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,i.jsxs)(t.p,{children:["When a timeout occurs, the middleware ",(0,i.jsx)(t.strong,{children:"returns immediately"})," without waiting for the\nhandler to finish. This is achieved through Fiber's ",(0,i.jsx)(t.strong,{children:"Abandon mechanism"}),":"]}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:"The handler runs in a goroutine with a timeout context"}),"\n",(0,i.jsxs)(t.li,{children:['On timeout, the middleware marks the context as "abandoned" and returns ',(0,i.jsx)(t.code,{children:"408"})," immediately"]}),"\n",(0,i.jsx)(t.li,{children:"The handler goroutine can continue safely (e.g., for cleanup) without blocking the response"}),"\n",(0,i.jsx)(t.li,{children:"A background cleanup goroutine waits for the handler to finish and performs context cleanup"}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["Handlers can detect the timeout by listening on ",(0,i.jsx)(t.code,{children:"c.Context().Done()"})," and return early.\nThis is the recommended pattern for cooperative cancellation."]}),"\n",(0,i.jsxs)(t.p,{children:["If a handler panics, the middleware catches it and returns ",(0,i.jsx)(t.code,{children:"500 Internal Server Error"}),"."]}),"\n",(0,i.jsx)(t.h2,{id:"known-limitations",children:"Known limitations"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Timed-out requests abandon their ",(0,i.jsx)(t.code,{children:"fiber.Ctx"})," to avoid data races with the core\nrequest handler (including the ",(0,i.jsx)(t.code,{children:"ErrorHandler"}),"). These contexts are ",(0,i.jsx)(t.strong,{children:"not"}),"\nreturned to the pool, so each timed-out request leaks a context. Calling\n",(0,i.jsx)(t.code,{children:"ForceRelease"})," is only safe if you can guarantee that no goroutine (including\nFiber internals) will touch the context anymore; the timeout middleware\nintentionally does not call it."]}),"\n"]}),"\n",(0,i.jsx)(t.admonition,{type:"caution",children:(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"timeout.New"})," wraps your final handler and can't be added with ",(0,i.jsx)(t.code,{children:"app.Use"})," or\nused in a middleware chain. Register it per route and avoid calling\n",(0,i.jsx)(t.code,{children:"c.Next()"})," inside the wrapped handler\u2014doing so will panic."]})}),"\n",(0,i.jsx)(t.h2,{id:"signatures",children:"Signatures"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:"func New(handler fiber.Handler, config ...timeout.Config) fiber.Handler\n"})}),"\n",(0,i.jsx)(t.h2,{id:"examples",children:"Examples"}),"\n",(0,i.jsx)(t.h3,{id:"basic-example",children:"Basic example"}),"\n",(0,i.jsxs)(t.p,{children:["The following program times out any request that takes longer than two seconds.\nThe handler simulates work with ",(0,i.jsx)(t.code,{children:"sleepWithContext"}),", which stops when the\ncontext is canceled:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'package main\n\nimport (\n    "context"\n    "fmt"\n    "log"\n    "time"\n\n    "github.com/gofiber/fiber/v3"\n    "github.com/gofiber/fiber/v3/middleware/timeout"\n)\n\nfunc sleepWithContext(ctx context.Context, d time.Duration) error {\n    select {\n    case <-time.After(d):\n        return nil\n    case <-ctx.Done():\n        return ctx.Err()\n    }\n}\n\nfunc main() {\n    app := fiber.New()\n\n    handler := func(c fiber.Ctx) error {\n        delay, _ := time.ParseDuration(c.Params("delay") + "ms")\n        if err := sleepWithContext(c.Context(), delay); err != nil {\n            return fmt.Errorf("%w: execution error", err)\n        }\n        return c.SendString("finished")\n    }\n\n    app.Get("/sleep/:delay", timeout.New(handler, timeout.Config{\n        Timeout: 2 * time.Second,\n    }))\n\n    log.Fatal(app.Listen(":3000"))\n}\n'})}),"\n",(0,i.jsx)(t.p,{children:"Use these requests to see the middleware in action:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"curl -i http://localhost:3000/sleep/1000   # finishes within the timeout\ncurl -i http://localhost:3000/sleep/3000   # returns 408 Request Timeout\n"})}),"\n",(0,i.jsx)(t.h2,{id:"config",children:"Config"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Property"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Type"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Description"}),(0,i.jsx)(t.th,{style:{textAlign:"left"},children:"Default"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Next"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"func(fiber.Ctx) bool"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["Function to skip this middleware when it returns ",(0,i.jsx)(t.code,{children:"true"}),"."]}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"nil"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Timeout"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"time.Duration"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["Timeout duration for requests. ",(0,i.jsx)(t.code,{children:"0"})," or a negative value disables the timeout."]}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"0"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"OnTimeout"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"fiber.Handler"})}),(0,i.jsxs)(t.td,{style:{textAlign:"left"},children:["Handler executed when a timeout occurs. Defaults to returning ",(0,i.jsx)(t.code,{children:"fiber.ErrRequestTimeout"}),"."]}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"nil"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Errors"}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"[]error"})}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:"Custom errors treated as timeout errors."}),(0,i.jsx)(t.td,{style:{textAlign:"left"},children:(0,i.jsx)(t.code,{children:"nil"})})]})]})]}),"\n",(0,i.jsx)(t.h3,{id:"use-with-a-custom-error",children:"Use with a custom error"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'var ErrFooTimeOut = errors.New("foo context canceled")\n\nfunc main() {\n    app := fiber.New()\n    h := func(c fiber.Ctx) error {\n        sleepTime, _ := time.ParseDuration(c.Params("sleepTime") + "ms")\n        if err := sleepWithContextWithCustomError(c.Context(), sleepTime); err != nil {\n            return fmt.Errorf("%w: execution error", err)\n        }\n        return nil\n    }\n\n    app.Get("/foo/:sleepTime", timeout.New(h, timeout.Config{Timeout: 2 * time.Second, Errors: []error{ErrFooTimeOut}}))\n    log.Fatal(app.Listen(":3000"))\n}\n\nfunc sleepWithContextWithCustomError(ctx context.Context, d time.Duration) error {\n    timer := time.NewTimer(d)\n    select {\n    case <-ctx.Done():\n        if !timer.Stop() {\n            <-timer.C\n        }\n        return ErrFooTimeOut\n    case <-timer.C:\n    }\n    return nil\n}\n'})}),"\n",(0,i.jsx)(t.h3,{id:"sample-usage-with-a-database-call",children:"Sample usage with a database call"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-go",children:'func main() {\n    app := fiber.New()\n    db, _ := gorm.Open(postgres.Open("postgres://localhost/foodb"), &gorm.Config{})\n\n    handler := func(ctx fiber.Ctx) error {\n        tran := db.WithContext(ctx.Context()).Begin()\n\n        if tran = tran.Exec("SELECT pg_sleep(50)"); tran.Error != nil {\n            return tran.Error\n        }\n\n        if tran = tran.Commit(); tran.Error != nil {\n            return tran.Error\n        }\n\n        return nil\n    }\n\n    app.Get("/foo", timeout.New(handler, timeout.Config{Timeout: 10 * time.Second}))\n    log.Fatal(app.Listen(":3000"))\n}\n'})})]})}function h(e={}){let{wrapper:t}={...(0,l.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},84429:function(e,t,n){n.d(t,{R:()=>o,x:()=>s});var r=n(96540);let i={},l=r.createContext(i);function o(e){let t=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(l.Provider,{value:t},e.children)}}}]);