"use strict";(self.webpackChunkfiber_docs=self.webpackChunkfiber_docs||[]).push([["51461"],{74746:function(e,t,n){n.r(t),n.d(t,{frontMatter:()=>s,toc:()=>c,default:()=>h,metadata:()=>i,assets:()=>o,contentTitle:()=>r});var i=JSON.parse('{"id":"middleware/idempotency","title":"Idempotency","description":"The Idempotency middleware helps build fault-tolerant APIs. Duplicate requests\u2014such as retries after network issues\u2014won\'t trigger the same action twice on the server.","source":"@site/docs/core/middleware/idempotency.md","sourceDirName":"middleware","slug":"/middleware/idempotency","permalink":"/next/middleware/idempotency","draft":false,"unlisted":false,"editUrl":"https://github.com/gofiber/fiber/edit/main/docs/middleware/idempotency.md","tags":[],"version":"current","lastUpdatedAt":1771794478000,"frontMatter":{"id":"idempotency"},"sidebar":"left_sidebar","previous":{"title":"Helmet","permalink":"/next/middleware/helmet"},"next":{"title":"KeyAuth","permalink":"/next/middleware/keyauth"}}'),l=n(74848),d=n(84429);let s={id:"idempotency"},r="Idempotency",o={},c=[{value:"HTTP Method Categories",id:"http-method-categories",level:2},{value:"Signatures",id:"signatures",level:2},{value:"Examples",id:"examples",level:2},{value:"Default Config (Skip <strong>Safe</strong> Methods)",id:"default-config-skip-safe-methods",level:3},{value:"Skip <strong>Idempotent</strong> Methods Instead",id:"skip-idempotent-methods-instead",level:3},{value:"Custom Config",id:"custom-config",level:3},{value:"Config",id:"config",level:2},{value:"Default Config Values",id:"default-config-values",level:2}];function a(e){let t={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(t.header,{children:(0,l.jsx)(t.h1,{id:"idempotency",children:"Idempotency"})}),"\n",(0,l.jsx)(t.p,{children:"The Idempotency middleware helps build fault-tolerant APIs. Duplicate requests\u2014such as retries after network issues\u2014won't trigger the same action twice on the server."}),"\n",(0,l.jsxs)(t.p,{children:["Refer to ",(0,l.jsx)(t.a,{href:"https://tools.ietf.org/html/rfc7231#section-4.2.2",children:"IETF RFC 7231 \xa74.2.2"})," for definitions of safe and idempotent HTTP methods."]}),"\n",(0,l.jsx)(t.h2,{id:"http-method-categories",children:"HTTP Method Categories"}),"\n",(0,l.jsxs)(t.ul,{children:["\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"Safe Methods"})," (do not modify server state): ",(0,l.jsx)(t.code,{children:"GET"}),", ",(0,l.jsx)(t.code,{children:"HEAD"}),", ",(0,l.jsx)(t.code,{children:"OPTIONS"}),", ",(0,l.jsx)(t.code,{children:"TRACE"})]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"Idempotent Methods"})," (identical requests have the same effect as a single one): all safe methods ",(0,l.jsx)(t.strong,{children:"plus"})," ",(0,l.jsx)(t.code,{children:"PUT"})," and ",(0,l.jsx)(t.code,{children:"DELETE"})]}),"\n"]}),"\n",(0,l.jsxs)(t.blockquote,{children:["\n",(0,l.jsx)(t.p,{children:"According to the RFC, safe methods never change server state, while idempotent methods may change state but remain safe to repeat."}),"\n"]}),"\n",(0,l.jsx)(t.h2,{id:"signatures",children:"Signatures"}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-go",children:"func New(config ...Config) fiber.Handler\nfunc IsFromCache(c fiber.Ctx) bool\nfunc WasPutToCache(c fiber.Ctx) bool\n"})}),"\n",(0,l.jsx)(t.h2,{id:"examples",children:"Examples"}),"\n",(0,l.jsx)(t.p,{children:"Import the middleware package:"}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-go",children:'import (\n    "github.com/gofiber/fiber/v3"\n    "github.com/gofiber/fiber/v3/middleware/idempotency"\n)\n'})}),"\n",(0,l.jsx)(t.p,{children:"Once your Fiber app is initialized, configure the middleware:"}),"\n",(0,l.jsxs)(t.h3,{id:"default-config-skip-safe-methods",children:["Default Config (Skip ",(0,l.jsx)(t.strong,{children:"Safe"})," Methods)"]}),"\n",(0,l.jsxs)(t.p,{children:["By default, the ",(0,l.jsx)(t.code,{children:"Next"})," function skips middleware for safe methods only:"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-go",children:"app.Use(idempotency.New())\n"})}),"\n",(0,l.jsxs)(t.h3,{id:"skip-idempotent-methods-instead",children:["Skip ",(0,l.jsx)(t.strong,{children:"Idempotent"})," Methods Instead"]}),"\n",(0,l.jsxs)(t.p,{children:["Skip all idempotent methods (including ",(0,l.jsx)(t.code,{children:"PUT"})," and ",(0,l.jsx)(t.code,{children:"DELETE"}),") by overriding ",(0,l.jsx)(t.code,{children:"Next"}),":"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-go",children:"app.Use(idempotency.New(idempotency.Config{\n    Next: func(c fiber.Ctx) bool {\n        // Skip middleware for idempotent methods (safe + PUT, DELETE)\n        return fiber.IsMethodIdempotent(c.Method())\n    },\n}))\n"})}),"\n",(0,l.jsx)(t.h3,{id:"custom-config",children:"Custom Config"}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-go",children:"app.Use(idempotency.New(idempotency.Config{\n    Lifetime: 42 * time.Minute,\n    // ...\n}))\n"})}),"\n",(0,l.jsx)(t.h2,{id:"config",children:"Config"}),"\n",(0,l.jsxs)(t.p,{children:["Idempotency keys are hidden in logs and error messages by default. Set ",(0,l.jsx)(t.code,{children:"DisableValueRedaction"})," to ",(0,l.jsx)(t.code,{children:"true"})," only when you need to expose them for debugging."]}),"\n",(0,l.jsxs)(t.table,{children:[(0,l.jsx)(t.thead,{children:(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"Property"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"Type"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"Description"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"Default"})]})}),(0,l.jsxs)(t.tbody,{children:[(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"Next"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"func(fiber.Ctx) bool"})}),(0,l.jsxs)(t.td,{style:{textAlign:"left"},children:["Function to skip this middleware when it returns ",(0,l.jsx)(t.code,{children:"true"}),"; use ",(0,l.jsx)(t.code,{children:"IsMethodSafe"})," or ",(0,l.jsx)(t.code,{children:"IsMethodIdempotent"}),"."]}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"func(c fiber.Ctx) bool { return fiber.IsMethodSafe(c.Method()) }"})})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"Lifetime"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"time.Duration"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"Maximum lifetime of an idempotency key."}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"30 * time.Minute"})})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"KeyHeader"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"string"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"Header name containing the idempotency key."}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:'"X-Idempotency-Key"'})})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"KeyHeaderValidate"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"func(string) error"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"Function to validate idempotency header syntax (e.g., UUID)."}),(0,l.jsxs)(t.td,{style:{textAlign:"left"},children:["UUID length check (",(0,l.jsx)(t.code,{children:"36"})," characters)"]})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"KeepResponseHeaders"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"[]string"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"List of headers to preserve from original response."}),(0,l.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,l.jsx)(t.code,{children:"nil"})," (keep all headers)"]})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"DisableValueRedaction"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"bool"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"Disables idempotency key redaction in logs and error messages."}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"false"})})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"Lock"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"Locker"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"Locks an idempotency key to prevent race conditions."}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"In-memory locker"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"Storage"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"fiber.Storage"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"Stores response data by idempotency key."}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"In-memory storage"})]})]})]}),"\n",(0,l.jsx)(t.h2,{id:"default-config-values",children:"Default Config Values"}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-go",children:'var ConfigDefault = Config{\n    Next: func(c fiber.Ctx) bool {\n        // Skip middleware for safe methods per RFC 7231 \xa74.2.2\n        return fiber.IsMethodSafe(c.Method())\n    },\n\n    Lifetime: 30 * time.Minute,\n\n    KeyHeader: "X-Idempotency-Key",\n    KeyHeaderValidate: func(k string) error {\n        if l, wl := len(k), 36; l != wl { // UUID length is 36 chars\n            return fmt.Errorf("%w: invalid length: %d != %d", ErrInvalidIdempotencyKey, l, wl)\n        }\n\n        return nil\n    },\n\n    KeepResponseHeaders: nil,\n\n    Lock: nil, // Set in configDefault so we don\'t allocate data here.\n\n    Storage: nil, // Set in configDefault so we don\'t allocate data here.\n    DisableValueRedaction: false,\n}\n'})})]})}function h(e={}){let{wrapper:t}={...(0,d.R)(),...e.components};return t?(0,l.jsx)(t,{...e,children:(0,l.jsx)(a,{...e})}):a(e)}},84429:function(e,t,n){n.d(t,{R:()=>s,x:()=>r});var i=n(96540);let l={},d=i.createContext(l);function s(e){let t=i.useContext(d);return i.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:s(e.components),i.createElement(d.Provider,{value:t},e.children)}}}]);